
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Defined Functions (UDF’s) explained &#8212; openeo 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" />
    <link rel="prev" title="Basic Usage" href="basics.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="user-defined-functions-udf-s-explained">
<h1>User Defined Functions (UDF’s) explained<a class="headerlink" href="#user-defined-functions-udf-s-explained" title="Permalink to this headline">¶</a></h1>
<p>User defined functions are a very important feature of OpenEO. They allow you as a user to
reuse existing code, by submitting it to the backend.</p>
<p>As datacubes can be very large, the backend will only be able to run your code on a smaller chunk
of the whole cube. So you need to help the backend a bit, by designing your code to work on as small
a piece of data as possible.</p>
<p>There are a few different types of operations where UDF’s can be used:</p>
<ol class="arabic simple">
<li><p>Applying a process to each pixel: <a class="reference external" href="https://open-eo.github.io/openeo-api/processreference/#apply">https://open-eo.github.io/openeo-api/processreference/#apply</a></p></li>
<li><p>Applying a process to all pixels along a dimension, without changing cardinality: apply_dimension</p></li>
<li><p>Reducing values along a dimension: <a class="reference external" href="https://open-eo.github.io/openeo-api/processreference/#reduce">https://open-eo.github.io/openeo-api/processreference/#reduce</a></p></li>
</ol>
<p>Not all functions will require you to write a custom process. For instance, if you want to take the absolute
value of your datacube, you can simply use the predefined absolute value function. In fact, it is
recommended to try and use predefined functions, as they can be more efficiëntly implemented.</p>
<p>However, when you have a large piece of code that is hard to transform into predefined openEO functions,
then it makes sense to use the UDF functionality.</p>
<p>The section below gives an example to get you started.</p>
<div class="section" id="example-smoothing-timeseries-with-a-user-defined-function-udf">
<h2>Example: Smoothing timeseries with a user defined function (UDF)<a class="headerlink" href="#example-smoothing-timeseries-with-a-user-defined-function-udf" title="Permalink to this headline">¶</a></h2>
<p>In this example, we start from the ‘evi_cube’ that was created in the previous example, and want to
apply a temporal smoothing on it. More specifically, we want to use the “Savitzky Golay” smoother
that is available in the SciPy Python library.</p>
<p>To ensure that openEO understand your function, it needs to follow some rules, the UDF specification.
This is an example that follows those rules:</p>
<div class="literal-block-wrapper docutils container" id="savgol-udf">
<div class="code-block-caption"><span class="caption-text">UDF code</span><a class="headerlink" href="#savgol-udf" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Uncomment the import only for coding support</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">from</span> <span class="nn">openeo_udf.api.datacube</span> <span class="kn">import</span> <span class="n">DataCube</span>


<span class="k">def</span> <span class="nf">apply_datacube</span><span class="p">(</span><span class="n">cube</span><span class="p">:</span> <span class="n">DataCube</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataCube</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a savitzky-golay smoothing to a timeseries datacube.</span>
<span class="sd">    This UDF preserves dimensionality, and assumes a datacube with a temporal dimension &#39;t&#39; as input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>

    <span class="n">array</span><span class="p">:</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
    <span class="n">filled</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">interpolate_na</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="n">smoothed_array</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">filled</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">DataCube</span><span class="p">(</span><span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">smoothed_array</span><span class="p">,</span><span class="n">dims</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span><span class="n">coords</span><span class="o">=</span><span class="n">array</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>

</pre></div>
</div>
</div>
<p>The method signature of the UDF is very important, because the backend will use it to detect
the type of UDF. This particular example accepts a ‘DataCube’ object as input and also returns a ‘DataCube’ object.
The type annotations and method name are actually used to detect how to invoke the UDF, so make sure they remain unchanged.</p>
<p>The API of the ‘DataCube’ class can be found here <a class="reference internal" href="api.html#datacube-api"><span class="std std-ref">openeo_udf.api.datacube.DataCube</span></a>.</p>
<p>Once the UDF is defined in a separate file, we need to load it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_resource</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
<span class="go">        return str(Path( relative_path))</span>

<span class="go">    def load_udf(relative_path):</span>
<span class="go">        import json</span>
<span class="go">        with open(get_resource(relative_path), &#39;r+&#39;) as f:</span>
<span class="go">            return f.read()</span>

<span class="go">    smoothing_udf = load_udf(&#39;udf/smooth_savitzky_golay.py&#39;)</span>
<span class="go">    print(smoothing_udf)</span>
</pre></div>
</div>
<p>after that, we can simply apply it along a dimension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">smoothed_evi</span> <span class="o">=</span> <span class="n">evi_cube_masked</span><span class="o">.</span><span class="n">apply_dimension</span><span class="p">(</span><span class="n">smoothing_udf</span><span class="p">,</span><span class="n">runtime</span><span class="o">=</span><span class="s1">&#39;Python&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="udf-function-names">
<h2>UDF function names<a class="headerlink" href="#udf-function-names" title="Permalink to this headline">¶</a></h2>
<p>There’s a predefined set of function signatures that you have to use to implement a UDF:</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">openeo</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Open-EO&repo=openeo-python-client&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/Open-EO/openeo-python-client">
    <img
        alt="https://secure.travis-ci.org/Open-EO/openeo-python-client.svg?branch=master"
        src="https://secure.travis-ci.org/Open-EO/openeo-python-client.svg?branch=master"
    />
</a>
</p>



  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">User Defined Functions (UDF’s) explained</a><ul>
<li><a class="reference internal" href="#example-smoothing-timeseries-with-a-user-defined-function-udf">Example: Smoothing timeseries with a user defined function (UDF)</a></li>
<li><a class="reference internal" href="#udf-function-names">UDF function names</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="basics.html" title="previous chapter">Basic Usage</a></li>
      <li>Next: <a href="api.html" title="next chapter">API</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->

<!-- CSS Adjustments from requests: https://github.com/kennethreitz/requests/blob/master/docs/_templates/hacks.html-->
<style type="text/css">
  /* Rezzy requires precise alignment. */
  img.logo {margin-left: -20px!important;}
  /* "Quick Search" should be capitalized. */
  div#searchbox h3 {text-transform: capitalize;}
  /* Make the document a little wider, less code is cut-off. */
  div.document {width: 1008px;}
  /* Much-improved spacing around code blocks. */
  div.highlight pre {padding: 11px 14px;}
  /* Remain Responsive! */
  @media screen and (max-width: 1008px) {
    div.sphinxsidebar {display: none;}
    div.document {width: 100%!important;}
    /* Have code blocks escape the document right-margin. */
    div.highlight pre {margin-right: -30px;}
  }
</style>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Jeroen Dries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/udf.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/Open-EO/openeo-python-client" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>